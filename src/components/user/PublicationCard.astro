---
import { cn } from '@/utils'
import Icon from './Icon.astro'
import SimpleIcon from './SimpleIcon.astro'

interface Props {
  class?: string
  publication: {
    title: string
    authors: Array<{
      name: string
      isMe?: boolean
      isEqual?: boolean
      isCoreContributor?: boolean
      role?: 'corresponding' | 'project-leader'
      homepage?: string
    }>
    venue: string
    year: string
    type: 'conference' | 'journal' | 'workshop' | 'preprint'
    abstract?: string
    links: {
      type: string
      href: string
    }[]
    status: 'published' | 'accepted' | 'under-review' | 'preprint'
    citations?: number
    authorsAlphabetical?: boolean
  }
}

const { class: className, publication } = Astro.props

const linkIconMap: Record<string, { type: 'simple' | 'builtin'; icon: string; color?: string }> = {
  pdf: { type: 'builtin', icon: 'document' },
  arxiv: { type: 'simple', icon: 'arxiv', color: '#B31B1B' },
  code: { type: 'simple', icon: 'github', color: '#181717' },
  github: { type: 'simple', icon: 'github', color: '#181717' },
  video: { type: 'simple', icon: 'youtube', color: '#FF0000' },
  poster: { type: 'builtin', icon: 'image' },
  slides: { type: 'builtin', icon: 'presentation' },
  ieee: { type: 'simple', icon: 'ieee', color: '#00629B' },
  acm: { type: 'simple', icon: 'acm', color: '#0085CA' },
  springer: { type: 'simple', icon: 'springer', color: '#FFCC33' },
  pytorch: { type: 'simple', icon: 'pytorch', color: '#EE4C2C' },
  tensorflow: { type: 'simple', icon: 'tensorflow', color: '#FF6F00' },
  model: { type: 'simple', icon: 'huggingface', color: '#FFD21E' },
  huggingface: { type: 'simple', icon: 'huggingface', color: '#FFD21E' },
  hf: { type: 'simple', icon: 'huggingface', color: '#FFD21E' },
  website: { type: 'builtin', icon: 'earth' },
  site: { type: 'builtin', icon: 'earth' },
  dataset: { type: 'simple', icon: 'huggingface', color: '#FFD21E' },
}

const typeColors = {
  conference: 'bg-sky-100 text-sky-800 dark:bg-sky-700 dark:text-sky-100',
  journal: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-700 dark:text-emerald-100',
  workshop: 'bg-amber-100 text-amber-800 dark:bg-amber-700 dark:text-amber-100',
  preprint: 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200'
}

const statusColors = {
  published: 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100',
  accepted: 'bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100',
  'under-review': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100',
  preprint: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-700 dark:text-indigo-100'
}

const symbolBaseClass = "text-primary dark:text-blue-400";
const symbolMutedClass = "text-muted-foreground/80 dark:text-slate-400/80";

---

<div class={cn('border rounded-xl p-4 transition-all group hover:border-foreground/25 hover:shadow-md', className)}>
  <div class='mb-3'>

    <p class='text-lg sm:text-xl text-foreground leading-tight mb-2 mt-0 transition-colors group-hover:text-primary' style='line-height: 1.4;'>
      {publication.title}
    </p>

    <div class='flex flex-wrap gap-2 mb-3'>
      <span
        class={cn('px-2.5 py-1 rounded-full text-xs font-medium whitespace-nowrap', typeColors[publication.type])}
      >
        {publication.type.charAt(0).toUpperCase() + publication.type.slice(1)}
      </span>
      <span
        class={cn('px-2.5 py-1 rounded-full text-xs font-medium whitespace-nowrap', statusColors[publication.status])}
      >
        {publication.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
      </span>
    </div>

    { publication.authors && publication.authors.length > 0 && (
      <div class='mb-3 text-sm text-muted-foreground dark:text-slate-300'>
        {publication.authors.map((author, index) => (
          <span class="author-item">
            {author.homepage ? (
              <a href={author.homepage} target='_blank' rel="noopener noreferrer" class='text-primary hover:underline transition-colors duration-200 dark:text-blue-400'>
                {author.isMe ? (
                  <strong class='text-foreground font-semibold dark:text-white'>{author.name}</strong>
                ) : (
                  author.name
                )}
              </a>
            ) : (
              author.isMe ? (
                <strong class='text-foreground font-semibold dark:text-white'>{author.name}</strong>
              ) : (
                author.name
              )
            )}
            {author.isEqual && <sup class={cn(symbolBaseClass, 'ml-px')}>*</sup>}
            {author.isCoreContributor && <sup class={cn(symbolBaseClass, 'ml-px')}>§</sup>}
            {author.role === 'corresponding' && <sup class={cn(symbolBaseClass, 'ml-px')}>†</sup>}
            {author.role === 'project-leader' && <sup class={cn(symbolBaseClass, 'ml-px')}>‡</sup>}
            {index < publication.authors.length - 1 && <span class="text-muted-foreground/70 dark:text-slate-400/70">, </span>}
          </span>
        ))}
      </div>
    )}

    {(publication.authors.some(a => a.isEqual || a.isCoreContributor || a.role) || publication.authorsAlphabetical) && (
      <div class={cn('mb-3 text-xs', symbolMutedClass, 'flex flex-wrap gap-x-3 gap-y-1')}>
        {publication.authors.some(a => a.isEqual) && <span><sup class={symbolBaseClass}>*</sup>Equal contribution</span>}
        {publication.authors.some(a => a.isCoreContributor) && <span><sup class={symbolBaseClass}>§</sup>Core contributor</span>}
        {publication.authors.some(a => a.role === 'project-leader') && <span><sup class={symbolBaseClass}>‡</sup>Project Leader</span>}
        {publication.authors.some(a => a.role === 'corresponding') && <span><sup class={symbolBaseClass}>†</sup>Corresponding author</span>}
        {publication.authorsAlphabetical && <span class="italic">Authors are listed in alphabetical order</span>}
      </div>
    )}

    <div class='mb-3 flex items-center flex-wrap gap-x-2 text-sm'>
      <span class='font-medium text-foreground dark:text-slate-200'>{publication.venue}</span>
      <span class='text-muted-foreground dark:text-slate-400'>•</span>
      <span class='text-muted-foreground dark:text-slate-400'>{publication.year}</span>
    </div>

    {
      publication.citations != null && publication.citations > 0 && (
        <div class='mb-4 flex items-center gap-1.5 text-xs text-muted-foreground dark:text-slate-400'>
          <Icon class='size-3.5 text-current' name='quote' />
          <span>{publication.citations} citation{publication.citations === 1 ? '' : 's'}</span>
        </div>
      )
    }
  </div> {/* 结束元信息区域的 div */}

  {/* 摘要 */}
  {
    publication.abstract && (
      <div class='mb-4'>
        <p class='text-sm leading-relaxed text-muted-foreground dark:text-slate-300'>
          {publication.abstract}
        </p>
      </div>
    )
  }

  {/* 链接按钮 */}
  {
    publication.links && publication.links.length > 0 && (
      <div class='flex flex-wrap gap-2 sm:gap-2.5'>
        {publication.links.map((link) => {
          const iconConfig = linkIconMap[link.type.toLowerCase()] || { type: 'builtin', icon: 'earth' };
          return (
            <a
              href={link.href}
              target='_blank'
              rel="noopener noreferrer"
              class='inline-flex items-center gap-1.5 rounded-md bg-muted px-3 py-1.5 text-xs font-medium text-muted-foreground transition-all hover:bg-muted/80 hover:text-foreground focus-visible:ring-2 focus-visible:ring-ring ring-offset-background ring-offset-2 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 dark:hover:text-slate-100 dark:focus-visible:ring-slate-500'
            >
              {iconConfig.type === 'simple' ? (
                <SimpleIcon 
                  class='size-3.5 sm:size-4' 
                  name={iconConfig.icon} 
                  color={iconConfig.color || 'currentColor'}
                />
              ) : (
                <Icon class='size-3.5 sm:size-4 text-current' name={iconConfig.icon as any} />
              )}
              <span class="hidden sm:inline">{link.type.toUpperCase()}</span>
              <span class="sm:hidden">{link.type.charAt(0).toUpperCase() + link.type.slice(1)}</span>
            </a>
          )
        })}
      </div>
    )
  }
</div>