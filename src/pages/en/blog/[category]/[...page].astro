---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

import { Paginator, PostPreview, CollectionPreview } from '@/components/pages'
import { getBlogCollectionEn, getUniqueCategories, getCollectionsByCategory, getUniqueTags, sortMDByDate, getPostCollections } from '@/server'
import { Button, Icon } from '@/components/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import config from '@/site-config'

export const prerender = true

export const getStaticPaths = (async ({ paginate }) => {
  const categoryMap: Record<string, string> = {
    'tech': 'Technical',
    'daily': 'Daily Life',
    'research': 'Research',
    'journal': 'Month Journal'
  }
  
  const categoryOrder = ['research', 'tech', 'daily', 'journal']
  
  const allCollections = await getBlogCollectionEn()
  const allUniqueCategories = getUniqueCategories(allCollections)
  
  const uniqueCategories = categoryOrder.filter(cat => allUniqueCategories.includes(cat))
  
  return uniqueCategories.flatMap((category, index) => {
    const collections = sortMDByDate(getCollectionsByCategory(allCollections, category))
    const uniqueTags = getUniqueTags(collections)
    const collectionsCount = collections.length
    
    // Get previous and next categories (circular navigation)
    const prevIndex = index === 0 ? uniqueCategories.length - 1 : index - 1
    const nextIndex = index === uniqueCategories.length - 1 ? 0 : index + 1
    const prevCategory = uniqueCategories[prevIndex]
    const nextCategory = uniqueCategories[nextIndex]
    
    return paginate(collections, {
      params: { category },
      pageSize: config.content?.blogPageSize || 8,
      props: { uniqueTags, collectionsCount, category, prevCategory, nextCategory, categoryMap }
    })
  })
}) satisfies GetStaticPaths

interface Props {
  page: Page<CollectionEntry<'blogEn'>>
  uniqueTags: string[]
  collectionsCount: number
  category: string
  prevCategory: string
  nextCategory: string
  categoryMap: Record<string, string>
}

const { page, uniqueTags, collectionsCount, category, prevCategory, nextCategory, categoryMap: categoryMapProp } = Astro.props

const categoryDisplayName = categoryMapProp[category] || category
const postCollections = await getPostCollections()

const meta = {
  description: `Posts in category: ${categoryDisplayName}`,
  title: `${categoryDisplayName} - Blog`
}
---

<PageLayout {meta}>
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <div class='category-nav-wrapper mb-6 mt-6 sm:mt-10'>
        <h1 class='inline-block text-3xl font-medium'>{categoryDisplayName}</h1>
        <div class='category-nav-arrows ml-3 inline-flex gap-1 align-middle'>
          <a 
            href={`/en/blog/${prevCategory}`}
            class='flex h-8 w-8 items-center justify-center transition-colors hover:text-primary'
            title={`Previous: ${categoryMapProp[prevCategory]}`}
            aria-label={`Go to ${categoryMapProp[prevCategory]}`}
          >
            <Icon name='up' class='size-5' />
          </a>
          <a 
            href={`/en/blog/${nextCategory}`}
            class='flex h-8 w-8 items-center justify-center transition-colors hover:text-primary'
            title={`Next: ${categoryMapProp[nextCategory]}`}
            aria-label={`Go to ${categoryMapProp[nextCategory]}`}
          >
            <Icon name='chevron-down' class='size-5' />
          </a>
        </div>
      </div>
    </div>
    {
      page.data.length === 0 ? (
        <p>No posts yet.</p>
      ) : (
        <div class='grid gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-8'>
          <section aria-label='Blog posts list' class='animate' id='content'>
            {/* header */}
            <div class='mb-3 flex flex-col justify-between text-sm sm:mb-5 sm:flex-row'>
              <span class='text-muted-foreground'>
                Page {page.currentPage} - Showing {page.data.length} of {collectionsCount} posts
              </span>
              <a aria-label='View all blog by years' href='/en/archives' data-astro-prefetch>
                View all posts by years →
              </a>
            </div>
            {/* posts */}
            <ul class='flex flex-col gap-y-4 text-start'>
              {page.data.map((post) => (
                <PostPreview {post} detailed />
              ))}
            </ul>
            <Paginator currentPage={page.currentPage} lastPage={page.lastPage} url={page.url} />
          </section>

          {/* sidebar */}
          {(!!uniqueTags.length || !!postCollections.length) && (
            <aside class='animate' id='sidebar'>
              {!!postCollections.length && (
                <div class='mb-8'>
                  <h2 class='mb-4 flex items-center text-lg font-semibold'>
                    <Icon name='package' class='me-2' />
                    Collections
                  </h2>
                  <ul class='flex flex-col gap-2'>
                    {postCollections.slice(0, 5).map((collection) => (
                      <CollectionPreview {collection} minimal />
                    ))}
                  </ul>
                  <span class='mt-4 block sm:text-end'>
                      <a aria-label='View all collections' href='/en/collection' data-astro-prefetch>
                      View all →
                      </a>
                  </span>
                </div>
              )}
              {!!uniqueTags.length && (
                <div>
                  <h2 class='mb-4 flex items-center text-lg font-semibold'>
                    <Icon name='tag-2' class='me-2' />
                    Tags
                  </h2>
                  <ul class='text-bgColor flex flex-wrap gap-2'>
                    {uniqueTags.map((tag) => (
                      <li>
                        <Button title={tag} href={`/en/tags/${tag}`} style='pill' />
                      </li>
                    ))}
                  </ul>
                  <span class='mt-4 block sm:text-end'>
                    <a aria-label='View all blog categories' href='/en/tags' data-astro-prefetch>
                      View all →
                    </a>
                  </span>
                </div>
              )}
            </aside>
          )}
        </div>
      )
    }
  </main>
</PageLayout>
